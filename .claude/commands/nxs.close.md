---
description: Close an epic by generating a Post-Implementation Report (PIR), updating documentation links, closing the GitHub issue, and cleaning up task files.
---

# Role

Act as a technical documentation specialist performing post-implementation documentation and cleanup operations.

# Context

- **Epic Source**: Resolved in priority order:
    1. Explicit file path provided in `$ARGUMENTS`
    2. The file currently open in the editor (passed as context)
- **User Input**: $ARGUMENTS

# Input Resolution

**CRITICAL**: Do NOT search for epic files. Resolve the epic source as follows:

1. **If `$ARGUMENTS` contains a file path**: Use that path directly
2. **If a file is provided in context** (open in editor): Use that file as the epic.md
3. **Otherwise**: Stop and ask the user to either:
    - Open the epic.md file in their editor and re-run the command, OR
    - Provide the file path as an argument: `/nxs.close path/to/epic.md`

**Never** run `find`, `ls`, or search commands to locate epic files.

# Workflow

## 1. Validate Epic State

Before proceeding, validate that the epic is ready for closure:

1. **Read and parse epic.md frontmatter** to extract:
    - `epic`: The epic title
    - `link`: The GitHub issue reference (e.g., `"#123"`)
    - `feature`: The parent feature name
    - `status`: Current status

2. **Validate required attributes**:
    - `link` MUST exist and contain a valid issue number
    - If `link` is missing: Stop and report:
        ```
        Cannot close epic: No GitHub issue linked.

        The epic.md frontmatter must contain a `link` attribute (e.g., `link: "#123"`).
        This is typically added when the epic issue is created via `/nxs.tasks`.
        ```

3. **Check for tasks/ subfolder**:
    - Verify `{epic-directory}/tasks/` exists
    - If missing, warn but allow proceeding (may have been manually cleaned)

## 2. Load Task Files

If `tasks/` subfolder exists:

1. Read all `TASK-*.md` files from `{epic-directory}/tasks/`
2. For each task file, extract:
    - Task ID and title (from frontmatter)
    - Summary section
    - Key Decisions section (if present)
    - Implementation Notes section (if present)
    - Acceptance Criteria (to verify completion)

3. If no task files found but `tasks/` exists:
    - Check for `task-review.md` (may be leftover from aborted run)
    - Proceed with minimal PIR content

## 3. Generate Post-Implementation Report (PIR.md)

Create `PIR.md` in the same directory as `epic.md`.

### PIR Template

```markdown
---
epic: "{Epic Title}"
created: {Current date in YYYY-MM-DD format}
type: post-implementation-report
---

# Post-Implementation Report: {Epic Title}

## Executive Summary

{2-3 sentences summarizing what was implemented and the overall outcome. Focus on the business value delivered.}

## Epic Objectives Achieved

{For each user story in epic.md, a brief statement of how it was addressed}

| Objective | Implementation Summary |
|-----------|----------------------|
| {Story 1 title} | {How it was implemented} |
| {Story 2 title} | {How it was implemented} |

## Key Decisions Made

{Consolidated table of significant decisions from task Key Decisions sections}

| Decision | Rationale | Task Reference |
|----------|-----------|----------------|
| {Decision 1} | {Why this choice was made} | TASK-{EPIC}.{NN} |
| {Decision 2} | {Why this choice was made} | TASK-{EPIC}.{NN} |

## Implementation Notes

{Any notable implementation details, challenges overcome, or deviations from the original design. Keep this concise and focused on what future maintainers need to know.}

## Files Changed

{Summary list of key files created or modified - not exhaustive, focus on primary components}

- `path/to/primary/file.ts` - {Purpose}
- `path/to/another/file.ts` - {Purpose}

## Testing Summary

{Brief overview of test coverage and any notable testing considerations}

## Future Considerations

{Any deferred scope, technical debt introduced, or recommendations for future iterations}

- {Item 1}
- {Item 2}

---

*Generated by nxs.close on {YYYY-MM-DD}*
```

### PIR Generation Guidelines

- **DO** keep summaries concise (focus on decisions and outcomes)
- **DO** reference task IDs when attributing decisions
- **DO** note any deviations from original HLD
- **DO NOT** include detailed code snippets
- **DO NOT** duplicate full task content verbatim
- **DO NOT** include implementation details that are obvious from the code

## 4. Update Epic's Related Documents Section

1. **Generate absolute URL for PIR.md** using the `nxs-abs-doc-path` skill:
    ```bash
    python ./.claude/skills/nxs-abs-doc-path/get_abs_doc_path.py "{epic-directory}/PIR.md"
    ```

2. **Locate the `### Related Documents` section** in epic.md:
    - Search for `### Related Documents` heading
    - If not found, search for `## Related Documents`
    - If still not found, create it before the closing `---` or at the end of the Appendix

3. **Add PIR.md link** to the Related Documents section:
    ```markdown
    - [Post-Implementation Report]({ABSOLUTE_URL_TO_PIR}) - Implementation summary and key decisions
    ```

## 5. Confirmation Checkpoint

**STOP AND WAIT** for user confirmation before destructive operations.

Present the following checkpoint:

```
CHECKPOINT: Epic Closure

I'm about to close epic "{Epic Title}" (#{issue-number}).

Actions to be performed:
1. PIR.md generated at `{epic-directory}/PIR.md`
2. epic.md updated with PIR link in Related Documents
3. Close GitHub issue #{issue-number}
4. Delete `{epic-directory}/tasks/` folder ({N} files)

Files to be deleted:
{List of files in tasks/ folder}

Proceed with closing the epic?

-   Yes, close the epic (y)
-   No, abort (n)
-   Review PIR.md first (r)
```

**STOP. Wait for user response.**

**Handle user response:**

- **`y` or `yes`**: Proceed to Step 6
- **`n` or `no`**: Abort with message:
    ```
    Epic closure aborted.

    PIR.md has been generated but the GitHub issue remains open.
    You can review and manually close when ready:
      gh issue close {issue-number}
    ```
- **`r` or `review`**: Display the generated PIR.md content, then re-present the confirmation prompt

## 6. Close GitHub Issue

Close the epic's GitHub issue:

```bash
gh issue close {issue-number} --reason completed
```

**Error Handling:**

- If issue is already closed: Report and continue to cleanup
- If `gh` command fails: Report error, preserve state, provide manual instructions

## 7. Delete Tasks Subfolder

Remove the entire `tasks/` directory:

```bash
rm -rf "{epic-directory}/tasks/"
```

**Pre-deletion verification:**

- Confirm path is within expected epic directory
- Never delete if path doesn't match expected pattern

## 8. Report Completion

Output a completion summary:

```
EPIC CLOSED: {Epic Title}

GitHub Issue: #{issue-number} - Closed
PIR Generated: {epic-directory}/PIR.md
Tasks Cleaned: {N} task files removed

Summary:
- {Brief summary from PIR executive summary}

Related Documents:
- Epic: {absolute URL to epic.md}
- PIR: {absolute URL to PIR.md}
- HLD: {absolute URL to HLD.md if exists}
```

# Constraints

- **DO NOT** search for epic files - use the provided context or arguments only
- **DO NOT** proceed past the Confirmation Checkpoint without explicit user confirmation
- **DO NOT** delete files outside the tasks/ subfolder
- **DO NOT** close the GitHub issue if PIR generation fails
- **DO NOT** include detailed code snippets in PIR.md
- **DO** verify the epic has a linked GitHub issue before proceeding
- **DO** generate absolute URLs using the `nxs-abs-doc-path` skill
- **DO** preserve epic.md, HLD.md, and tasks.md (only delete tasks/ folder)
- **DO** handle already-closed issues gracefully

# Error Handling

## Missing GitHub Issue Link

```
Cannot close epic: No GitHub issue linked.

The epic.md frontmatter must contain a `link` attribute (e.g., `link: "#123"`).
Run `/nxs.tasks` first to create and link the GitHub issue.
```

## GitHub CLI Failure

```
GitHub CLI Error: {error message}

The PIR.md has been generated and epic.md updated.
Please manually close the issue:
  gh issue close {issue-number} --reason completed

Then delete the tasks folder:
  rm -rf "{epic-directory}/tasks/"
```

## Empty Tasks Folder

```
Notice: No task files found in tasks/ folder.

Proceeding with minimal PIR generation. The report will contain:
- Epic objectives (from epic.md)
- Placeholder for implementation details

You may want to manually enhance PIR.md with implementation specifics.
```

# Execution

1. **Resolve epic.md file** (see Input Resolution above - do not search)
2. If no epic.md can be resolved, stop and ask user to specify one
3. **Validate epic state**:
    - Parse frontmatter and extract `link` attribute
    - If missing, stop with clear error
4. **Extract issue number** from `link` attribute (e.g., `"#123"` -> `123`)
5. **Locate tasks/ subfolder** in same directory as epic.md
6. **Read all task files** and extract relevant sections:
    - Task titles and summaries
    - Key Decisions tables
    - Implementation Notes
7. **Read epic.md user stories** to map objectives to implementations
8. **Generate PIR.md** using the template and extracted content
9. **Generate absolute URL** for PIR.md using `nxs-abs-doc-path` skill:
    ```bash
    python ./.claude/skills/nxs-abs-doc-path/get_abs_doc_path.py "{repo-relative-path-to-PIR.md}"
    ```
10. **Update epic.md** Related Documents section with PIR link
11. **CONFIRMATION CHECKPOINT - STOP AND WAIT**:
    - Present summary of actions to be performed
    - List files to be deleted
    - Wait for explicit user confirmation
    - Handle response (proceed, abort, or review)
12. **Close GitHub issue** via:
    ```bash
    gh issue close {issue-number} --reason completed
    ```
13. **Delete tasks/ subfolder** via:
    ```bash
    rm -rf "{epic-directory}/tasks/"
    ```
14. **Report completion** with summary and links
